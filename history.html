<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ประวัติการวิเคราะห์ | Durian Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body{font-family:"Prompt",system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text-color);margin:0;background:var(--background-color);}
    header{border-bottom:1px solid var(--border-color);}    
    .container{padding:20px}
    .header-content{display:flex;justify-content:space-between;align-items:center;padding:10px 0}
    .nav-brand{display:flex;align-items:center;gap:10px;color:var(--text-color);text-decoration:none}
    .nav-logo{height:40px;width:40px;border-radius:10px}
    .animate-color{background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));-webkit-background-clip:text;background-clip:text;color:transparent}
    .back-home-button{border:1px solid var(--border-color);padding:8px 14px;border-radius:10px;text-decoration:none;color:var(--text-color)}
    .card{background:#fff;border:1px solid var(--border-color);border-radius:16px;padding:18px}
    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:#fff;z-index:1}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border-color);vertical-align:top}
    tr:hover{background:#FAFCFF}
    .cell-date{white-space:nowrap;width:140px}
    .cell-result{white-space:nowrap;width:180px}
    .pill{display:inline-block;background:var(--background-color);border:1px solid var(--border-color);padding:2px 10px;border-radius:12px;margin:2px}
    .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:10000;align-items:center;justify-content:center}
    .modal{background:#fff;min-width:320px;max-width:900px;width:90vw;padding:24px;border-radius:16px;position:relative}
    .close{position:absolute;top:10px;right:12px;font-size:22px;background:none;border:none;color:#888;cursor:pointer}
    .chart-box{display:flex;gap:24px;justify-content:center;margin-top:12px}
    .chart-cell{text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="nav-brand">
          <img src="assets/logo.png" class="nav-logo" alt="logo" />
          <h1 class="animate-color">Durian Analytics</h1>
        </a>
        <a href="index.html" class="back-home-button">← กลับหน้าแรก</a>
      </div>
    </div>
  </header>
  <main>
    <div class="container">
      <div class="dashboard-title">
        <h1>ประวัติการวิเคราะห์</h1>
      </div>
      <div class="card">
        <div id="history-table"></div>
      </div>
    </div>
  </main>

  <div class="modal-bg" id="history-modal">
    <div class="modal">
      <button class="close" onclick="closeModal()">×</button>
      <h3 style="margin-top:0">รายละเอียดการวิเคราะห์</h3>
      <div id="modal-detail"></div>
      <div class="chart-box">
        <div class="chart-cell">
          <div style="font-weight:600;margin-bottom:6px">กราฟความรู้สึก</div>
          <canvas id="modal-sentiment-chart" width="240" height="240"></canvas>
        </div>
      </div>
      <div style="margin-top:14px">
        <div style="font-weight:600;margin-bottom:6px">คำแนะนำแคมเปญ (ถ้ามี)</div>
        <div id="modal-suggestion" style="background:var(--background-color);padding:10px 14px;border-radius:10px;border:1px solid var(--border-color)"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // Check authentication before loading page
    if (!authManager.isLoggedIn()) {
      window.location.href = 'login.html';
    }
  </script>
  <script>
    const key='durian_history';
    function getHistory(){ try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch{ return []; } }
    function render(){
      const arr = getHistory();
      const el = document.getElementById('history-table');
      if(!arr.length){ el.innerHTML = '<div style="padding:18px;text-align:center;color:#8aa">ไม่มีประวัติ</div>'; return; }
      const rows = arr.map((x,i)=>`
        <tr data-idx="${i}" class="row">
          <td class="cell-date">${x.date||'-'}</td>
          <td>${(x.text||'').replace(/</g,'&lt;')}</td>
          <td class="cell-result"><b>${x.sentiment||'-'}</b> (${x.polarity||'-'} / ${Math.round(x.score||0)}%)</td>
          <td>${(x.keywords?.pos||[]).slice(0,6).map(k=>`<span class="pill">${k}</span>`).join('')}
              ${(x.keywords?.neg||[]).slice(0,6).map(k=>`<span class="pill">${k}</span>`).join('')}</td>
        </tr>`).join('');
      el.innerHTML = `<table>
        <thead><tr><th class="cell-date">วันที่</th><th>ข้อความ</th><th class="cell-result">ผลลัพธ์</th><th>คำสำคัญ</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
      document.querySelectorAll('.row').forEach(tr=> tr.addEventListener('click',()=> showModal(+tr.dataset.idx)));
    }

    function showModal(idx){
      const it = getHistory()[idx];
      const modal = document.getElementById('history-modal');
      modal.style.display='flex';
      const detail = document.getElementById('modal-detail');
      detail.innerHTML = `
        <div><b>วันที่:</b> ${it.date||'-'}</div>
        <div style="margin:6px 0"><b>ข้อความ:</b><br><span class="pill" style="display:inline-block;margin-top:6px">${(it.text||'').replace(/</g,'&lt;')}</span></div>
        <div><b>ผลวิเคราะห์:</b> ${it.sentiment||'-'} (${it.polarity||'-'} / ${Math.round(it.score||0)}%)</div>
      `;
      // Chart (ใช้สัดส่วนจากคีย์เวิร์ดจริง ถ้ามี)
      if(window._m){ window._m.destroy(); }
      let d = [0,0,0]; // [pos, neu, neg]
      const posArr = it.keywords?.pos || [];
      const negArr = it.keywords?.neg || [];
      const mixArr = it.keywords?.keyword || [];
      const totalKW = posArr.length + negArr.length + mixArr.length;
      if(totalKW > 0){
        d = [ (posArr.length/totalKW)*100, (mixArr.length/totalKW)*100, (negArr.length/totalKW)*100 ];
      } else {
        if(it.polarity==='positive'){ d[0]=it.score; d[1]=Math.max(0,100-it.score-5); d[2]=100-d[0]-d[1]; }
        else if(it.polarity==='negative'){ d[2]=it.score; d[1]=Math.max(0,100-it.score-5); d[0]=100-d[1]-d[2]; }
        else { d[1]=it.score; d[0]=Math.max(0,100-it.score-10); d[2]=100-d[0]-d[1]; }
      }
      window._m = new Chart(document.getElementById('modal-sentiment-chart').getContext('2d'),{
        type:'doughnut',
        data:{ labels:['เชิงบวก','เป็นกลาง','เชิงลบ'], datasets:[{ data:d.map(x=>Math.round(x)), backgroundColor:['#4AD8B9','#FFB86B','#FF9248'], borderWidth:0 }]},
        options:{ responsive:false, plugins:{legend:{position:'bottom'}} , cutout:'70%' }
      });
      document.getElementById('modal-suggestion').textContent = (it.campaign?.idea || it.campaign?.taglines?.join(' • ') || '—');
    }
    function closeModal(){ document.getElementById('history-modal').style.display='none'; }

    document.addEventListener('DOMContentLoaded', render);
  </script>
</body>
</html>
