// Domain Tuner for Durian Analytics
// ==================================

// Enhanced Domain Tuner (เวอร์ชันปรับปรุง)
// ครอบคลุม: รสชาติ กลิ่น เนื้อสัมผัส คุณภาพ ราคา ประสบการณ์กิน/บริการ/ขนส่ง/อารมณ์/บริบท
const DOMAIN = {
    positive: [
        // รสชาติ / กลิ่น / เนื้อสัมผัส
        'อร่อย','หอม','หวาน','มัน','ครีมมี่','เนื้อแน่น','เนื้อครีม','เนียน','ละมุน','นุ่มละมุน',
        'หนึบ','หนึบหนับ','ละลายในปาก','หวานมัน','หวานกลมกล่อม','หอมละมุน','หอมหวาน','กลิ่นดี',
        'รสชาติเยี่ยม','รสชาติดี','รสชาติเด็ด','รสชาติสุดยอด','รสชาติเลิศ','รสชาติเยอะ','รสชาติเข้มข้น',
        'กลิ่นหอม','กลิ่นดี','กลิ่นเยี่ยม','กลิ่นน่าทาน','กลิ่นชวนกิน','กลิ่นหอมหวาน',
        'เนื้อสวย','เนื้อสุก','เนื้อนุ่ม','เนื้อนิ่ม','เนื้อฟู','เนื้อแน่น','เนื้อหนา','เนื้อเยอะ',
        // คุณภาพผลไม้
        'สด','สดใหม่','สดจากสวน','สุกกำลังดี','คัดเกรด','คัดพิเศษ','เกรดพรีเมียม','คัดเกรดส่งออก',
        'ของแท้จากสวน','คุณภาพดี','ลูกใหญ่','เนื้อเยอะ','เนื้อแน่นไม่เละ','คุณภาพเยี่ยม','คุณภาพเลิศ',
        'เกรดเอ','เกรดพรีเมียม','เกรดส่งออก','เกรดพรีเมียม','เกรดดี','เกรดเยี่ยม',
        // ความคุ้มค่า/ประสบการณ์/อารมณ์
        'คุ้มค่า','คุ้มราคา','ราคาดี','ชอบมาก','ซื้อซ้ำ','ฟิน','ฟินมาก','ฟินสุดๆ','อร่อยมาก',
        'ราชาแห่งผลไม้','ทุเรียนพรีเมียม','ทุเรียนหมอนทองแท้','ทุเรียนดีมาก','ทุเรียนเยี่ยม',
        'ประทับใจ','ชอบใจ','ถูกใจ','พอใจ','ยินดี','ดีใจ','สุขใจ','อิ่มใจ','ฟินใจ',
        'แนะนำ','แนะนำให้','แนะนำเลย','แนะนำมาก','แนะนำสุดๆ','แนะนำให้เพื่อน','บอกต่อ',
        // บริการ/ขนส่ง/แพ็คกิ้ง
        'บริการดี','ตอบไว','ดูแลดี','ส่งไว','จัดส่งไว','ถึงเร็ว','แพ็คดี','แพ็กดี','แพ็คแน่นหนา','ห่อดี',
        'บริการเยี่ยม','บริการเลิศ','บริการประทับใจ','บริการน่าประทับใจ','บริการดีมาก',
        // คำเสริม/การยืนยัน
        'จริงๆ','จริง','แน่นอน','แน่ใจ','ยืนยัน','คอนเฟิร์ม','รับประกัน','การันตี','มั่นใจ',
        'สุดยอด','เลิศ','เยี่ยม','ดีมาก','ดีเยี่ยม','ดีเลิศ','ดีสุดๆ','ดีมากๆ','ดีมากมาย'
    ],

    negative: [
        // รสชาติ / กลิ่น / เนื้อสัมผัส
        'ไม่อร่อย','รสชาติไม่ดี','รสชาติแย่','ไม่หวาน','ไม่มัน','ขม','ขมปี๋','กลิ่นแรง','กลิ่นแปลก',
        'เหม็น','เหม็นเขียว','เหม็นหืน','เหม็นเน่า','รสชาติเหม็นเขียว','รสชาติแย่','รสชาติไม่ดี',
        'กลิ่นเหม็น','กลิ่นแรง','กลิ่นแปลก','กลิ่นไม่ดี','กลิ่นแย่','กลิ่นเหม็นเขียว','กลิ่นเหม็นหืน',
        'เนื้อเละ','เละ','เนื้อยุ่ย','เนื้อแห้ง','เนื้อแข็ง','เนื้อไม่แน่น','เนื้อไม่ดี','เนื้อดำ',
        'เนื้อไม่สวย','เนื้อไม่สุก','เนื้อแข็ง','เนื้อแห้ง','เนื้อเละ','เนื้อยุ่ย','เนื้อไม่นุ่ม',
        // คุณภาพผลไม้
        'บูด','เน่า','เน่าเสีย','เสียของ','เพี้ยน','เก่า','ไม่สด','ไม่สดใหม่','คุณภาพแย่',
        'เกรดต่ำ','เกรดไม่ดี','เกรดแย่','เกรดเสีย','เกรดไม่ผ่าน','เกรดไม่โอเค',
        // ความคุ้มค่า/ประสบการณ์/อารมณ์
        'ไม่คุ้ม','ไม่คุ้มเลย','ไม่โอเค','ไม่ไหว','ผิดหวัง','ห่วย','แย่','เสีย','พัง','เสียเงินเปล่า','ไม่สมราคา',
        'กินไม่ได้','ท้องเสีย','ได้ของไม่ตรงปก','ปลอม','ทุเรียนปลอม','ทุเรียนไม่แท้',
        'ไม่ประทับใจ','ไม่ชอบใจ','ไม่ถูกใจ','ไม่พอใจ','ไม่ยินดี','ไม่ดีใจ','ไม่สุขใจ','ไม่อิ่มใจ',
        'ไม่แนะนำ','ไม่แนะนำให้','ไม่แนะนำเลย','ไม่แนะนำมาก','ไม่แนะนำสุดๆ','ไม่บอกต่อ',
        // บริการ/ขนส่ง/แพ็คกิ้ง/ราคา
        'แพง','ราคาแพงเกินไป','ส่งช้า','จัดส่งช้า','แพ็คไม่ดี','แพ็กไม่ดี','ห่อไม่ดี','บูดก่อนถึง','คืนเงิน',
        'บริการแย่','บริการไม่ดี','บริการไม่โอเค','บริการห่วย','บริการเสีย','บริการพัง',
        // คำปฏิเสธ/การยืนยันเชิงลบ
        'ไม่จริง','ไม่แน่นอน','ไม่แน่ใจ','ไม่ยืนยัน','ไม่คอนเฟิร์ม','ไม่รับประกัน','ไม่การันตี','ไม่มั่นใจ',
        'แย่','ห่วย','เสีย','พัง','ไม่ดี','ไม่โอเค','ไม่ไหว','ไม่ผ่าน','ไม่ผ่านเกณฑ์'
    ],

    // คำ/วลีเปิดประโยคปฏิเสธที่พบบ่อย
    negationHeads: ['ไม่','ไม่ค่อย','ไม่ค่อยจะ','ไม่มี','ไม่ได้','ไม่โอเค','ไม่ไหว','ไม่ผ่าน','ไม่ผ่านเกณฑ์'],
    
    // คำเสริมความหมายเชิงลบ
    negativeIntensifiers: ['มาก','มากๆ','มากมาย','สุดๆ','เกินไป','เกิน','หนัก','แรง','แย่','ห่วย','เสีย','พัง'],
    
    // คำเสริมความหมายเชิงบวก
    positiveIntensifiers: ['มาก','มากๆ','มากมาย','สุดๆ','เยี่ยม','เลิศ','ดี','เยอะ','แรง','เข้มข้น']
};

// ตรวจ "ไม่ + คำบวก" แบบครอบคลุม
const NEGATE_POS_REGEX = /ไม่\s*(อร่อย|ดี|สด|ใหม่|คุ้ม|คุ้มค่า|ชอบ|โอเค|หวาน|มัน|หอม|นุ่ม|ละมุน|ฟิน|คัดเกรด|พรีเมียม)/;

// Utility Functions
function containsAny(text, arr) { 
    return arr.some(w => text.includes(w)); 
}

function countHits(text, arr) {
    // นับแบบง่าย ๆ: เจอคำกี่คำในข้อความ
    return arr.reduce((n,w)=> n + (text.split(w).length - 1), 0);
}

// Main Domain Tuning Function
function domainTune(text, ssense) {
    // ดึงผลดิบจาก S-Sense
    let polarity = ssense?.sentiment?.polarity || 'neutral';
    let score = Math.min(100, Math.max(0, parseFloat(ssense?.sentiment?.score || '50')));

    const t = text.trim();

    // สรุปจำนวน hit จากลิสต์
    const negHits = countHits(t, DOMAIN.negative) + (NEGATE_POS_REGEX.test(t) ? 2 : 0);
    const posHits = countHits(t, DOMAIN.positive);
    
    // ตรวจสอบคำเสริมความหมาย
    const negIntensifierHits = countHits(t, DOMAIN.negativeIntensifiers);
    const posIntensifierHits = countHits(t, DOMAIN.positiveIntensifiers);

    // กฎจัดชั้น (ปรับปรุงให้แม่นยำขึ้น)
    // 1) เจอ "ไม่ + คำบวก" หรือพบคำลบแรง ๆ → ลบทันที
    if (NEGATE_POS_REGEX.test(t) || t.includes('ไม่อร่อย')) {
        polarity = 'negative';
        score = Math.max(score, 78 + Math.min(negHits * 3, 12)); // ดันคะแนนลบให้สูง
    }
    // 2) ถ้าโมเดลให้ neutral แต่ negHits > posHits ชัดเจน → ลบ
    else if (polarity === 'neutral' && negHits > posHits) {
        polarity = 'negative';
        score = 65 + Math.min(negHits * 4, 20);
    }
    // 3) ถ้าโมเดลให้ neutral แต่ posHits > negHits → บวก
    else if (polarity === 'neutral' && posHits > negHits) {
        polarity = 'positive';
        score = 65 + Math.min(posHits * 4, 20);
    }
    
    // 4) ปรับคะแนนตามคำเสริมความหมาย
    if (polarity === 'positive' && posIntensifierHits > 0) {
        score = Math.min(100, score + (posIntensifierHits * 5));
    } else if (polarity === 'negative' && negIntensifierHits > 0) {
        score = Math.min(100, score + (negIntensifierHits * 5));
    }

    // รวมคีย์เวิร์ดเพื่อโชว์ใน UI
    const posArr = Array.from(new Set([...(ssense?.preprocess?.pos||[]), ...DOMAIN.positive.filter(w=>t.includes(w))]));
    const negArr = Array.from(new Set([...(ssense?.preprocess?.neg||[]), ...DOMAIN.negative.filter(w=>t.includes(w)), ...(containsAny(t, DOMAIN.negationHeads)?['ไม่']:[]) ]));
    const mixArr = (ssense?.preprocess?.keyword || []).filter(k=>!posArr.includes(k) && !negArr.includes(k));

    // ส่งกลับรูปแบบเดียวกับเดิมเพื่อให้ UI เดิมใช้ต่อได้ทันที
    return { polarity, score, preprocess: { pos: posArr, neg: negArr, keyword: mixArr } };
}

// Export functions
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { domainTune, DOMAIN, NEGATE_POS_REGEX, containsAny, countHits };
}
